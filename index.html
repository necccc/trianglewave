<html>
<head>
  <script type="text/javascript" src="paper-full.min.js"></script>
  <script type="text/javascript" src="perlin.js"></script>
</head>
<body>

  <canvas id="Trianglewave" style="width:1200px; height: 400px;"></canvas>





  <script type="text/paperscript" canvas="Trianglewave">

noise.seed(Math.random());

  var hypotenuse = function (a) {
    return Math.sqrt(Math.pow(a, 2) * 2);
  }


  var raster = new Raster('bg1080.jpg');
  var loaded = false;
  var sqwidth = 64;
  var unitSize = new Size(sqwidth, sqwidth);
  var largeSide = hypotenuse(sqwidth);
  var halfLargeSide = largeSide / 2;

raster.on('load', function() {
  raster.fitBounds(view.bounds, true);
  loaded = true;

  var startX = view.center.x - Math.ceil(view.center.x / largeSide) * largeSide;
  var next = [
    startX,
    view.center.y - Math.ceil(view.center.y / largeSide) * largeSide
  ];

  var line = 0;
  var end = false;
  var mesh = [];

  while(next) {
    var res = generateSquare(next, line, mesh);
    var pre = (line % 4 == 0) ? 1 : -1;

    if (res[0] > view.size.width && res[1] > view.size.height && end == false) {

      end = line + 1
      res[0] = startX + (pre * halfLargeSide/2);
      res[1] = next[1] + halfLargeSide;
      line += 2;

    } else if (res[0] > view.size.width) {

      if (end) {
        next = false;
        break;
      }

      res[0] = startX + (pre * halfLargeSide/2);
      res[1] = next[1] + halfLargeSide;
      line += 2;

    } else {

      res[0] = next[0] + largeSide;
      res[1] = next[1]

    }

    next = res;
  }

  view.onFrame = function (e) {
    mesh.map(function (tri) {
        tri.JSCwaveProp[0] += e.delta*1.4
        tri.opacity = wavePoint.apply(null, tri.JSCwaveProp)
    })
  }

});

function onMouseEnter () {
  this.fillColor='red';
}
function onMouseLeave () {
  this.fillColor='white';
}

function wavePoint (x, line, pre) {

  var l = line + Math.sin(line)

  return 0.7 * Math.pow(
    Math.sin(
      ( x + l + (pre * sqwidth/2) ) / 3
    ), 2
  ) + 0.2
}

function generateSquare (coords, line, mesh) {
  var x = coords[0],
      y = coords[1];

  var rand = [];
  if (Math.random() > 0.55) {
    rand = [0,2]
  } else {
    rand = [1,3]
  }



  var center = new Point(x-(halfLargeSide), y-(halfLargeSide))

  var triangle1 = new Path.Rectangle(center, unitSize);
  triangle1.fillColor='white';
  triangle1.removeSegment(rand[0]); // 0
  triangle1.rotate(45);
  triangle1.blendMode = 'screen'
  //triangle1.opacity = Math.pow(Math.sin((x+sqwidth)/2),2)
  triangle1.opacity = wavePoint(x, line, 1)
triangle1.JSCwaveProp = [x, line, 1]

  triangle1.onMouseEnter = onMouseEnter
  triangle1.onMouseLeave = onMouseLeave

  mesh.push(triangle1)

  var triangle2 = new Path.Rectangle(center, unitSize);
  triangle2.fillColor='white';
  triangle2.removeSegment(rand[1]); // 2
  triangle2.rotate(45);
  triangle2.blendMode = 'screen'
  //triangle2.opacity =Math.pow(Math.sin((x-sqwidth)/2),2)
  triangle2.opacity = wavePoint(x, line+1, -1)

triangle2.JSCwaveProp = [x, line+1, -1]

  triangle2.onMouseEnter = onMouseEnter
  triangle2.onMouseLeave = onMouseLeave

  mesh.push(triangle2)

  return [x+(halfLargeSide), y+(halfLargeSide)];

}


  </script>

</body>
</html>
